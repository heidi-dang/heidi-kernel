name: ci

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  governance-gate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate .gitmodules exists
        run: |
          if [ ! -f .gitmodules ]; then
            echo "FAIL: .gitmodules is missing"
            exit 1
          fi
          echo "PASS: .gitmodules exists"

      - name: Validate .local submodule is configured
        run: |
          if ! grep -q 'submodule ".local"' .gitmodules; then
            echo "FAIL: .local submodule is not configured in .gitmodules"
            exit 1
          fi
          echo "PASS: .local submodule is configured"

      - name: Validate .local submodule pointer changed
        run: |
          git fetch origin main:main --depth=1
          if ! git diff --name-only main..HEAD | grep -q '^\.local$'; then
            echo "FAIL: PR must update .local submodule pointer"
            echo "Every PR must include a .local submodule pointer update."
            exit 1
          fi
          echo "PASS: .local submodule pointer updated"
